/*
Web Site Advantage: Adding Schema.org rating and review markup to Yotpo [v2.0]
https://websiteadvantage.com.au/Yotpo-Product-Rating-Review-Rich-Snippets
Copyright (C) 2016 Web Site Advantage
*/
var wsa_yotpoPlaceHolder = ".yotpo-main-widget";
var wsa_yotpoSdFormat = "microdata"; // microdata, json-ld
var webSiteAdvantage=webSiteAdvantage||{};webSiteAdvantage.yotpoRichSnippets=webSiteAdvantage.yotpoRichSnippets||[];webSiteAdvantage.yotpoRichSnippets=function(n){this.initialise(n)};webSiteAdvantage.yotpoRichSnippets.prototype={yotpoPlaceHolder:wsa_yotpoPlaceHolder,format:wsa_yotpoSdFormat,constructor:webSiteAdvantage.yotpoRichSnippets,initialise:function(n){try{if(typeof n!="undefined"&&n!=null&&(this.yotpoPlaceHolder=n),document.querySelector(this.yotpoPlaceHolder)==null&&(console.log("yotpoRichSnippets: Could not find yotpoPlaceHolder "+this.yotpoPlaceHolder),this.yotpoPlaceHolder=".yotpo.placeholder",console.log("yotpoRichSnippets: Trying "+this.yotpoPlaceHolder)),this._yotpoPlaceHolderElement=document.querySelector(this.yotpoPlaceHolder),this._yotpoPlaceHolderElement!=null){var t=this;this._observer=new MutationObserver(function(n){n.forEach(function(n){var r=n.addedNodes,u;if(r!==null)for(i=0;i<r.length;i++)u=r[i],typeof u.classList!="undefined"&&u.classList.contains("yotpo-display-wrapper")&&(t._observer.disconnect(),t._observer=null,t._addMarkup())})});this._observer.observe(this._yotpoPlaceHolderElement,this._observerConfig)}else console.log("yotpoRichSnippets: Could not find yotpoPlaceHolder "+this.yotpoPlaceHolder),console.log("yotpoRichSnippets: Failed")}catch(r){console.log("yotpoRichSnippets: initialise Error: "+r.message)}},_markupAdded:!1,_observer:null,_observerConfig:{attributes:!0,childList:!0,characterData:!0,subtree:!0},_yotpoPlaceHolderElement:null,_getCount:function(n){var i=document.querySelector('.yotpo-distibutions-sum-reviews span[data-score-distribution="'+n+'"]'),t;return i!=null&&(t=i.textContent,t.length>=3)?parseInt(t.substr(1,t.length-2)):0},_getReviewCount:function(){var t=document.querySelector(".yotpo-reviews-nav-tab-sum"),n;return t!=null&&(n=t.textContent,n.length>=3)?parseInt(n.substr(1,n.length-2)):(console.log("yotpoRichSnippets: Failed to find reviewCount. Using 0"),0)},_addMarkup:function(){var l,a,o,t,s,n,f,h,e;if(!this._markupAdded){this._markupAdded=!0;try{var v=this._getCount(5),y=this._getCount(4),p=this._getCount(3),w=this._getCount(2),b=this._getCount(1),u=v+y+p+w+b,c=(v*5+y*4+p*3+w*2+b*1)/u;if(u==0&&(u=this._getReviewCount(),c=document.querySelectorAll(".yotpo-stars-and-sum-reviews .yotpo-stars .yotpo-icon-star").length+document.querySelectorAll(".yotpo-stars-and-sum-reviews .yotpo-stars .yotpo-icon-half-star").length/2),u>0){for(l=window.location.href,a=document.querySelector("link[rel='canonical']"),a&&(l=a.getAttribute("href")),o={"@context":"http://schema.org/","@type":"Product","@id":l+"#Product",review:[]},this.format=="microdata"&&(t=document.querySelector(".yotpo-stars-and-sum-reviews"),t!=null?(t.setAttribute("id","yotpo-aggregate-rating"),t.setAttribute("itemprop","aggregateRating"),t.setAttribute("itemscope",""),t.setAttribute("itemtype","http://schema.org/AggregateRating")):console.log("yotpoRichSnippets: Failed to find aggregateRating Element"),this._addItemProps(t,".based-on","reviewCount",u),this._addItemProps(t,".yotpo-stars-and-sum-reviews .yotpo-stars","ratingValue",c),this._appendItemPropMetaTag(t,"worstRating","1"),this._appendItemPropMetaTag(t,"bestRating","5")),this.format=="json-ld"&&(o.aggregateRating={"@type":"AggregateRating",worstRating:"1",bestRating:"5",ratingValue:c,reviewCount:u}),s=this._yotpoPlaceHolderElement.querySelectorAll(".yotpo-review"),s.length==0&&console.log("yotpoRichSnippets: Failed to find any reviews"),r=0;r<s.length;r++)if(n=s[r],!n.classList.contains("yotpo-hidden")&&(this.format=="microdata"&&(n.setAttribute("itemprop","review"),n.setAttribute("itemscope",""),n.setAttribute("itemtype","http://schema.org/Review")),f=n.querySelector(".yotpo-review-stars"),h="",f!=null?(this.format=="microdata"&&(f.setAttribute("itemprop","reviewRating"),f.setAttribute("itemscope",""),f.setAttribute("itemtype","http://schema.org/Rating")),h=n.querySelectorAll(".yotpo-icon-star").length,this.format=="microdata"&&this._appendItemPropMetaTag(f,"ratingValue",h)):console.log("yotpoRichSnippets: Failed to find reviewRating Element for review "+i),this.format=="microdata"&&(this._addItemProps(n,'div[itemprop="review"] > .yotpo-header .yotpo-user-name',"author"),this._addItemProps(n,'div[itemprop="review"] > .yotpo-header .content-title .yotpo-font-bold',"name"),this._addItemProps(n,'div[itemprop="review"] > .yotpo-main .content-review',"reviewBody"),this._addItemProps(n,'div[itemprop="review"] > .yotpo-header .yotpo-review-date',"datePublished")),this.format=="json-ld")){var k=this._getInnerHTML(n,"div > .yotpo-header .yotpo-user-name"),d=this._getInnerHTML(n,"div > .yotpo-header .content-title .yotpo-font-bold"),g=this._getInnerHTML(n,"div > .yotpo-main .content-review"),nt=this._getInnerHTML(n,"div > .yotpo-header .yotpo-review-date");o.review.push({"@type":"Review",author:{"@type":"Person",name:k},reviewRating:{"@type":"Rating",ratingValue:h},name:d,reviewBody:g,datePublished:nt})}this.format=="json-ld"&&(e=document.createElement("script"),e.type="application/ld+json",e.setAttribute("id","wsa-yotpo-json-id"),e.text=JSON.stringify(o),document.querySelector("head").appendChild(e))}}catch(tt){console.log("yotpoRichSnippets: _addMarkup Error: "+tt.message)}}},_appendItemPropMetaTag:function(n,t,i){var r=document.createElement("meta");r.setAttribute("itemprop",t);r.setAttribute("content",i);n.appendChild(r)},_addItemProps:function(n,t,r,u){var e=n.querySelectorAll(t),f;for(i=0;i<e.length;i++)f=e[i],f.setAttribute("itemprop",r),typeof u!="undefined"&&u!=null&&f.setAttribute("content",u)},_getInnerHTML:function(n,t){var i=n.querySelectorAll(t);return i.length>0?i[0].innerHTML:""}};new webSiteAdvantage.yotpoRichSnippets